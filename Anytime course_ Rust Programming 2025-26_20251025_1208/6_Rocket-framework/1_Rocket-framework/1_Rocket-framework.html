<!doctype html>
<html>
<head>
    <title>1_Rocket-framework</title>
    <meta charset="utf-8">
    
</head>
<body>
<a name="top"></a><h1>Rocket-framework</h1><p class="book_summary"><p dir="ltr" style="text-align: left;">Tässä osiossa käsittelemme web-ohjelmoinnin backend-toteutusta Rust-kielellä Rocket-frameworkin avulla. Käymme läpi GET-request, POST-request, HTML-datan renderöinnin, HTML-formin käsittelyn.<br></p></p><div class="book_toc_numbered"><a name="toc"></a><h2 class="text-center pb-5">Table of contents</h2><ul><li><a title="1. Rocket-frameworkin käyttö" class="font-weight-bold text-decoration-none" href="#ch15276">1. Rocket-frameworkin käyttö</a></li><li><a title="2. HTML renderöinti" class="font-weight-bold text-decoration-none" href="#ch15278">2. HTML renderöinti</a><ul><li><a title="2.1. Form-lomake" class="text-decoration-none" href="#ch15279">2.1. Form-lomake</a></li></ul></li><li><a title="3. POST-request ja Postman" class="font-weight-bold text-decoration-none" href="#ch15277">3. POST-request ja Postman</a></li></ul></div><div class="book_chapter"><a name="ch15276"></a><h2>1. Rocket-frameworkin käyttö</h2><h4 dir="ltr" style="text-align: left;">Mikä on Rocket framework?</h4><div>Rocket on Rust-ohjelmointikielelle kehitetty web-sovelluskehys, joka mahdollistaa nopeiden, tyypiturvallisten web-sovellusten luomisen helposti. Sen intuitiiviset API:t tekevät siitä lähestyttävän kehittäjille taustasta riippumatta. Rocket tarjoaa tuen muun muassa lomakkeiden käsittelyyn ja JSON-datan käsittelyyn.<br></div><div>Jos et ole aiemmin harrastanut web-ohjelmointia, lisää tietoa get ja post-requesteista sekä geneerisesti HTTP-requesteista löydät <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods">täältä</a>.<br></div><div><br></div><p dir="ltr" style="text-align: left;"><br></p><h4 dir="ltr" style="text-align: left;">Rocket frameworkin käyttö - GET Request<br></h4><div>Katsotaan Rocket frameworkin käyttöä esimerkkien kautta. Alla on uusi projekti, jonka main.rs tiedosto on korvattu alla olevalla koodinpätkällä:</div><div><br><pre>#[macro_use] extern crate rocket;<br><br>#[get("/hello/&lt;name&gt;")]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>hello(name: <span class="" style="color: rgb(125, 159, 211);">String</span>) -&gt; String {<br>&nbsp;&nbsp;&nbsp; format!("Hei, {}!", name)<br>}<br>#[launch]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>rocket() -&gt; _ {<br>&nbsp;&nbsp;&nbsp; rocket::build().mount("/", routes![hello])<br>}</pre><br></div><div>Käydään esimerkkikoodi läpi rivi-riviltä.</div><div>Ylin rivi:</div><div><pre>#[macro_use] extern crate rocket;</pre></div><div>tuo Rocketin käyttämät attribuutit ja makrot kuten #[get] ja #[launch] käyttöön. get-makrolla voimme tehdä get-reitin (route).<br></div><p dir="ltr" style="text-align: left;"><br></p><p dir="ltr" style="text-align: left;"></p><p><span><span><span>#[get("/hello/&lt;name&gt;")]</span>:</span></span><br>Tämä attribuutti määrittää reitin ja parametrin:</p><p>/hello määrittelee polun URL-osoitteessa.&nbsp;</p><p>&lt;name&gt; merkitsee dynaamista parametria, joka otetaan mukaan URL:sta (esim. /hello/Matti).<br></p><br><span><br></span><pre><span><span>hello(name: String):</span></span><br><span></span></pre><p><span>Funktio, joka käsittelee GET-pyynnön. Parametri <em>name </em>vastaa URL:ssa annettua arvoa, ja se muunnetaan automaattisesti <em>String</em>-tyypiksi Rocketin toimesta.</span></p><p>Palautus:&nbsp;</p><pre>format!("Hei, {}!", name)<span></span><br><span></span></pre><p><span>Funktio palauttaa merkkijonon, joka luodaan <a href="https://doc.rust-lang.org/std/macro.format.html">format</a>!-makrolla. Tässä tapauksessa se tervehtii käyttäjää annetun nimen perusteella.</span></p><pre><span><span>#[launch] ja rocket::build():</span></span><br><span></span></pre><p><span>Tämä kohta käynnistää Rocket-sovelluksen:</span></p><p><span><br></span></p><pre><span>rocket::build().mount("/", routes![hello])</span></pre>Liittää hello-reitin sovelluksen juuri-polkuun ( / ).<br><p></p><p dir="ltr" style="text-align: left;">Kun sovellus ajetaan <em>cargo run</em> komennolla, pitäisi sovellus käynnistä. Kun teet sitten selaimella tai API-työkalulla pyynnön osoitteeseen:</p><pre>http://localhost:8000/hello/Matti</pre><p dir="ltr" style="text-align: left;">Vastaus on:</p><pre dir="ltr" style="text-align: left;">Hei, Matti!<br><br></pre><p>Kun ajat sovelluksen, pitäisi käyttämäsi IDE:n konsoliin tulla kasa tekstiä, joista viimeisimpien joukossa on:<br></p><pre>Rocket has launched from http://127.0.0.1:8000</pre><p>Kopioi tämä lause ja mene selaimella tuohon osoitteeseen. Sinun pitäisi saada 404-errori. Muista, että teit reitin vain <em>/hello/&lt;parametri1&gt;</em><span> osoitteeseen, joten laita ylläolevan osoitteen perään vielä haluamasi nimi, kuten <em>/hello/opiskelija</em><span>. Tällöin sinulla pitäisi näkyä teksti:</span></span></p><p><span><span><img src="data/kuva.png" alt="" role="presentation" class="img-fluid"><br></span></span></p><p>Ja konsolissasi alla olevan kaltaista:</p><pre dir="ltr" style="text-align: left;"><img src="data/kuva%20%281%29.png" alt="" role="presentation" class="img-fluid"><br><br></pre><p>Response eli vastaus palvelimelta, ohjelmaltamme, oli onnistunut, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status">response-koodi</a> oli <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/200">200</a>, ja ohjelma tunnisti että teimme pyynnön /hello/opiskelija osoitteeseen.</p><p>Huomaa, että get-reitin funktion parameterin nimen on oltava sama, kuin reitissä käyttämämme parametri. Esimerkkimme tapauksessa käytämmä reitissämme <em>&lt;name&gt;</em>, ja funktiomme parametrina <em>name</em>.<br></p><pre dir="ltr" style="text-align: left;"><br></pre><p dir="ltr" style="text-align: left;"><a href="https://rocket.rs/guide/v0.5/introduction/#introduction">Rocket-frameworkin oma dokumenttisivu</a><br></p></div><a href="#toc">&uarr; top</a><div class="book_chapter"><a name="ch15278"></a><h2>2. HTML renderöinti</h2><h4>HTML renderöinti <br></h4>Voimme näyttää dataa käyttäjälle paremmin HTML muodossa käyttäen Rocket-frameworkin RawHtml-moduulia. <br><p><br></p><br><pre>#[macro_use] extern crate rocket;<br>use rocket::response::content::RawHtml;<br>#[get("/&lt;page_name&gt;")]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>render_page(page_name: String) -&gt; RawHtml&lt;&amp;'static str&gt; {<br>&nbsp;&nbsp;&nbsp; <span class="" style="color: rgb(125, 159, 211);">let </span>content = <span class="" style="color: rgb(125, 159, 211);">match </span>page_name.as_str() {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "welcome" =&gt; "&lt;h1&gt;Tervetuloa!&lt;/h1&gt;&lt;p&gt;Ilo nähdä sinut täällä.&lt;/p&gt;",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; "about" =&gt; "&lt;h1&gt;Tietoa meistä&lt;/h1&gt;&lt;p&gt;Olemme Rocket-esimerkkisovellus.&lt;/p&gt;",<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _ =&gt; "&lt;p&gt;Sivua ei löytynyt.&lt;/p&gt;",<br>&nbsp;&nbsp;&nbsp; };<br>&nbsp;&nbsp;&nbsp; RawHtml(content)<br>}<br>#[launch]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>rocket() -&gt; _ {<br>&nbsp;&nbsp;&nbsp; rocket::build().mount("/page", routes![render_page])<br>}</pre><p dir="ltr" style="text-align: left;">Jotta voimme näyttää käyttäjälle HTML-muodossa dataa, pitää meidän palauttaa RawHTML tyypin arvo, joka sisältää haluamamme HTML:n. Kuten näemme, funktiossamme on palautustyyppinä RawHTML, ja jotta ohjelma toimisi, pitää meidän asettaa myös elinkaari/lifetime palautusarvollemme. <br></p><p dir="ltr" style="text-align: left;"><br></p><h4 dir="ltr" style="text-align: left;">Miksi käytetään 'static?<br></h4><p>Koska <em>RawHtml </em>palauttaa viitteen (&amp;str) HTML-sisältöön, ohjelman täytyy varmistaa, ettei se yritä käyttää vapautettua muistia. <a href="https://doc.rust-lang.org/rust-by-example/scope/lifetime/static_lifetime.html#reference-lifetime">'static varmistaa,</a> että palautettu HTML on aina olemassa ohjelman suorituksen ajan. <br></p><br><h4 dir="ltr" style="text-align: left;">Esimerkkiajo<br></h4><p dir="ltr" style="text-align: left;">Kun ajamme ylläolevan koodin, saamme /page-reittiin kaksi alareittiä, /welcome ja /about. Kun menemme osoitteeseen /about, saamme seuraavanlaisen näkymän:</p><p dir="ltr" style="text-align: left;"><img src="data/kuva.png" alt="" role="presentation" class="img-fluid"></p><p dir="ltr" style="text-align: left;"><br></p><p dir="ltr" style="text-align: left;">Kuten huomaamme, lähettämämme tieto renderöidään antamamme HTML-tiedon mukaisesti. "Tietoa meistä" on H1-elementissä, ja "Olemme Rocket-esimerkkisovellus." -teksti on p-elementin sisällä. Listan eri HTML elementeistä löydät <a href="https://www.w3schools.com/tags/">täältä</a>. <br></p><p dir="ltr" style="text-align: left;">Yleisimpiä elementtejä on:</p><ul dir="ltr"><li style="text-align: left;"><a href="https://www.w3schools.com/tags/tag_hn.asp">h1 ... h6</a> -määrittää headerin/otsikon ja sen koon</li><li style="text-align: left;"><a href="https://www.w3schools.com/tags/tag_p.asp">p</a>- normaalit tekstiosiot menevät tämän elementin sisälle</li><li style="text-align: left;"><a href="https://www.w3schools.com/tags/tag_div.asp">div</a>- käytetään eri osioiden lokeroinnissa ryhmittämisessä</li><li style="text-align: left;"><a href="https://www.w3schools.com/tags/tag_form.asp">form</a>- lomakeformaatti, johon voi laittaa sisälle useita eri elementtejä kuten <a href="https://www.w3schools.com/tags/tag_button.asp">button</a>, <a href="https://www.w3schools.com/tags/tag_input.asp">input</a></li><li style="text-align: left;">input-tyypistä on monia eri vaihtoehtoja, kuten checkbox, submit, radio, range<br></li></ul><div><br></div><div><br></div><div><br></div></div><a href="#toc">&uarr; top</a><div class="book_chapter"><a name="ch15279"></a><h3>2.1. Form-lomake</h3><h4 dir="ltr" style="text-align: left;">Esimerkki form-lomakkeen käytöstä</h4><div>Alla on esimerkkikoodi form-lomakkeen renderöinnistä RawHtml-funktion avulla. Määrittelemme formin sisälle input-elementtejä antaen niille halumiamme tyyppejä.</div><div><br></div><div><div><pre>#[macro_use]<br>extern crate rocket;<br><br>use rocket::form::{Form, FromForm};<br><br>use rocket::response::content::RawHtml;<br><br>#[derive(FromForm)]<br><br><span class="" style="color: rgb(125, 159, 211);">struct </span>UserInput {<br>    nimi: <span class="" style="color: rgb(125, 159, 211);">String</span>,<br>    ikä: <span class="" style="background-color: rgb(125, 159, 211);">u32</span>,<br>}<br><br>#[post("/submit", data = "&lt;user_form&gt;")]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>handle_form(user_form: Form&lt;UserInput&gt;) -&gt; <span class="" style="color: rgb(125, 159, 211);">String </span>{<br>    <span class="" style="color: rgb(125, 159, 211);">let </span>user = user_form.into_inner();<br><br>    format!("Käyttäjä: {} ({}) vuotta", user.nimi, user.ikä)<br>}<br><br>#[get("/form")]<br><span class="" style="color: rgb(125, 159, 211);">fn </span>form_page() -&gt; RawHtml&lt;&amp;'static str&gt; {<br>    <span class="" style="color: rgb(125, 159, 211);">let </span>rendered_page: &amp;str = r#"<br><br>    &lt;form action="/submit" method="post"&gt;<br><br>        &lt;label for="nimi"&gt;Nimi:&lt;/label&gt;<br><br>        &lt;input type="text" id="nimi" name="nimi" required&gt;<br><br>        &lt;br&gt;<br><br>        &lt;label for="age"&gt;Ikä:&lt;/label&gt;<br><br>        &lt;input type="number" id="ikä" name="ikä" required&gt;<br><br>        &lt;br&gt;&lt;br&gt;<br><br>        &lt;input type="submit" value="Lähetä"&gt;<br><br>    &lt;/form&gt;<br><br>    "#;<br><br>    RawHtml(rendered_page)<br>}<br><br>#[launch]<br><br><span class="" style="color: rgb(125, 159, 211);">fn </span>rocket() -&gt; _ {<br>    rocket::build().mount("/", routes![form_page, handle_form])<br>}<br><br><br><br></pre><p>Käytämme uusia ominaisuuksia Rocket-kirjastosta - Form, ja FromForm. Attribuutti #[derive(FromForm)] mahdollistaa Rust-rakenteen - struct - automaattisen täyttämisen lomakedatasta Rocketin avulla.</p><p><br></p><h4><strong>Miten se toimii?</strong></h4><p>Rocket parsii POST- tai GET-lomakepyynnöistä saadut kentät ja täyttää ne vastaaviin rakenteen kenttiin. Nimet täsmäävät HTML-lomakkeen kenttien nimien kanssa.</p><pre>#[derive(FromForm)]
<span class="" style="color: rgb(125, 159, 211);">struct </span>UserInput {
    nimi: <span class="" style="color: rgb(125, 159, 211);">String</span>,
    ikä: <span class="" style="color: rgb(125, 159, 211);">u32</span>,
}<br><br></pre></div>Ylläoleva UserInput -rakenne vastaanottaa seuraavat HTML-lomakekentät:</div><div><pre>&lt;form action="/submit" method="post"&gt;<br>&nbsp;&nbsp;&nbsp; &lt;input type="text" name="nimi"&gt;<br>&nbsp;&nbsp;&nbsp; &lt;input type="number" name="ikä"&gt;<br>&lt;/form&gt;<br><br></pre><h5><strong>Validointi</strong></h5><p>Jos lomakedata puuttuu, ei täsmää, tai sisältää väärän tyyppisen arvon (esim. teksti numerokentässä), Rocket palauttaa lomakkeen käsittelyyn liittyvän virheen. <br></p><p><br></p><h5><strong>F</strong><strong>orm </strong><strong>Datavartija (Data Guard)</strong></h5><p>Form&lt;UserInput&gt; on Rocketin tarjoama <a href="https://api.rocket.rs/v0.5/rocket/data/trait.FromData#data-guards">datavartija</a>, joka varmistaa, että lomakedata on oikeanmuotoista ja voidaan muuntaa määriteltyyn Rust-rakenteeseen.</p><p><br></p><h5><strong>Miten Form toimii?</strong></h5><p>Rocket lukee lomakedatan automaattisesti HTTP-pyynnön rungosta, suorittaa FromForm-muunnoksen, ja jos muunnos onnistuu, se antaa pääsyn tietorakenteeseen.</p><ul><li>data = "&lt;user_form&gt;" kertoo Rocketille, että se odottaa saavansa dataa, joka talletetaan user_form muuttujaan</li><li>Form&lt;UserInput&gt; lukee ja tarkistaa datan</li><li>user_form.into_inner() palauttaa varsinaisen UserInput-rakenteen käsittelyyn.</li></ul><div>Tämän jälkeen esimerkkimme muuttuja <em>user</em><span> on UserInput-tyypin instanssi, jonka kenttijä name ja age voimme kutsua normaalisti:</span></div><pre><span>user.nimi</span></pre><pre><span>user.ikä<br><br></span></pre><p></p></div><div><h5><strong>Ohjelman ajo<br></strong></h5></div><div>Alla näemme ohjelman toiminnan. <br></div><div><img src="data/kuva.png" alt="" role="presentation" class="img-fluid"></div><div><br></div><div>Renderöimme sivun form-lomakkeen /form-reitille, lähetämme datan /submit-routeen ja lähettäessämme datan, pääsemme toiselle sivulle.</div><div><img src="data/kuva%20%281%29.png" alt="" role="presentation" class="img-fluid"><br></div><div><br></div><div><br></div></div><a href="#toc">&uarr; top</a><div class="book_chapter"><a name="ch15277"></a><h2>3. POST-request ja Postman</h2><h4 dir="ltr" style="text-align: left;">Mikä on Postman?</h4><div>Postman on ilmainen API työkalu, jonka avulla voit esimerkiksi testata HTTP-reittejä, antaa dataa lähetettäviksi näihin routeihin ja katsoa mitä saat vastaukseksi.</div><div>Koska POST-routet vaativat dataa body:n sisällä, ei pelkkä selaimen käyttö anna meille helppoja keinoja kokeilla POST-routejamme.</div><div><br></div><div>Postmanin käyttöohjeet löydät <a href="https://learning.postman.com/docs/introduction/overview/">täältä</a>.</div><div>Postman Agent asennuslinkin löydät <a href="https://www.postman.com/downloads/postman-agent/">täältä</a>. Postman Agent toimii siten, että voit lähettää ja vastaanottaa requesteja kun Postman Agent on asennettu ja olet luonut tilin Postmaniin.</div><div><br></div><div>Routejesi testaus jonkun palvelun kuten Postman-kautta ei ole pakollista, mutta helpottaa ohjelmointitehtäviesi tekemistä.<br></div><div><br></div><div><br></div><h4><span>Miten teen POST-reitin?</span></h4><div><span>Alla näemme kuvan, jossa lähetetään uuden requestin kautta POST-pyyntö osoitteeseen localhost:8000/math/tuplaus.</span><strong><br></strong></div><div><span>Olemme valinneet Bodyyn datatyypiksi <em>r</em></span><em><span>aw</span></em><span><span>, jotta voimme lähettää tekstiä sellaisenaan. Esimerkissämme lähetämme arvon 5, tekstimuodossa.<br></span></span></div><div><span><span>Alla näemme Responsen koodin, 200, sekä tekstivastauksen:</span></span></div><div><span><span><br></span></span></div><pre><span><span><span>Kaksinkertainen arvo: 10<br><br></span></span></span><em><strong></strong></em></pre><div><strong><img src="data/kuva.png" alt="" role="presentation" class="img-fluid"><br></strong></div><div><strong><br></strong></div><div><strong><br></strong></div><div><span>Alla näemme koodin, jolla saimme ylläolevan post-routen tehtyä.</span></div><div><span><div><div>#[macro_use] extern crate rocket;</div><br><div>#[post("/tuplaus", data = "&lt;number&gt;")]</div><div><span class="" style="color: rgb(125, 159, 211);">fn </span>double_number(number: <span class="" style="color: rgb(125, 159, 211);">String</span>) -&gt; <span class="" style="color: rgb(125, 159, 211);">String </span>{</div><div>&nbsp; &nbsp; <span class="" style="color: rgb(125, 159, 211);">match </span>number.trim().parse::&lt;<span class="" style="color: rgb(125, 159, 211);">i32</span>&gt;() {</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Ok(value) =&gt; format!("Kaksinkertainen arvo: {}", value * 2),</div><div>&nbsp; &nbsp; &nbsp; &nbsp; Err(_) =&gt; String::from("Anna kelvollinen kokonaisluku!"),</div><div>&nbsp; &nbsp; }</div><div>}</div><br><div>#[launch]</div><div><span class="" style="color: rgb(125, 159, 211);">fn </span>rocket() -&gt; _ {</div><div>&nbsp; &nbsp; rocket::build()</div><div>&nbsp; &nbsp; &nbsp; &nbsp; .mount("/math", routes![double_number])</div><div>}</div><br></div>Lähetämme datan hieman samalla tyylillä #[post] makron sisällä kuin #[get] makrossa, mutta emme määrittele parametria url-osoitteen sisällä, vaan annamme sen erillisesti.<br></span></div><div><span><br></span><strong></strong></div></div><a href="#toc">&uarr; top</a>
</body>
</html>